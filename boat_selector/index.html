<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Group boat purchase calculator - Coordinate financing and budget planning for shared boat ownership">
    <meta name="author" content="Eivind Bakke">
    <title>Boat Purchase Calculator - Eivind Bakke</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        // Configure Tailwind to use our unified design system colors
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#2563eb',
                            dark: '#1e40af',
                            light: '#3b82f6'
                        },
                        secondary: {
                            DEFAULT: '#10b981',
                            dark: '#059669',
                            light: '#34d399'
                        },
                        accent: {
                            DEFAULT: '#f59e0b',
                            dark: '#d97706',
                            light: '#fbbf24'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Override default font to match design system */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .btn {
            @apply px-4 py-2 rounded-lg font-medium transition-all shadow-sm;
        }
        .btn:hover {
            @apply shadow-md transform -translate-y-0.5;
        }
        .btn-primary {
            @apply bg-primary text-white hover:bg-primary-dark;
        }
        .btn-secondary {
            @apply bg-gray-300 text-gray-700 hover:bg-gray-400;
        }
        .btn-green {
            @apply bg-secondary text-white hover:bg-secondary-dark;
        }
        .btn-orange {
            @apply bg-accent text-white hover:bg-accent-dark;
        }
        .input-field {
            @apply w-full p-2 border border-gray-300 rounded-lg transition-all;
        }
        .input-field:focus {
            @apply outline-none ring-2 ring-primary border-primary;
        }

        /* Mobile Responsive Enhancements */
        @media (max-width: 768px) {
            .tab-button {
                font-size: 0.875rem;
                padding: 0.625rem 0.75rem;
            }

            .boat-type-btn {
                font-size: 0.875rem;
                padding: 0.75rem 0.5rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            h2 {
                font-size: 1.25rem;
            }

            /* Make grids single column on mobile */
            .grid.md\:grid-cols-2 {
                grid-template-columns: 1fr;
            }

            .grid.md\:grid-cols-3 {
                grid-template-columns: 1fr;
            }

            /* Larger touch targets for buttons */
            button {
                min-height: 44px;
                min-width: 44px;
            }

            /* Better spacing on mobile */
            .space-y-6 > * + * {
                margin-top: 1rem;
            }

            /* Improve number input on mobile */
            input[type="number"] {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }

        @media (max-width: 480px) {
            .max-w-4xl {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            .tab-button {
                font-size: 0.813rem;
                padding: 0.5rem;
            }

            .boat-type-btn {
                font-size: 0.75rem;
                padding: 0.625rem 0.375rem;
            }

            h1 {
                font-size: 1.25rem;
            }

            h2 {
                font-size: 1.125rem;
            }

            /* Smaller text in cards */
            .text-2xl {
                font-size: 1.5rem;
            }

            .text-xl {
                font-size: 1.125rem;
            }

            /* Stack share button on mobile */
            .flex.justify-between.items-center {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            /* Full width Finn.no button on mobile */
            #finn-search-link {
                width: 100%;
                justify-content: center;
            }
        }

        /* Improve scroll behavior on mobile */
        @media (max-width: 768px) {
            body {
                -webkit-overflow-scrolling: touch;
            }

            /* Better padding for mobile containers */
            .bg-blue-50, .bg-green-50 {
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div class="bg-white shadow-md border-b border-gray-200">
        <div class="max-w-4xl mx-auto px-4 py-5">
            <a href="../index.html" class="inline-flex items-center text-primary hover:bg-primary hover:text-white px-3 py-2 rounded-lg text-sm font-medium transition-all mb-3 gap-1">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Portfolio
            </a>
            <h1 class="text-3xl font-bold text-gray-900 mb-1">Boat Purchase Calculator</h1>
            <p class="text-gray-600 text-lg">Financial planning and coordination tool for group boat ownership</p>
            <div class="mt-3 flex gap-2 flex-wrap">
                <span class="px-2.5 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded">Financial Modeling</span>
                <span class="px-2.5 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded">Loan Amortization</span>
                <span class="px-2.5 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded">jQuery</span>
                <span class="px-2.5 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded">Tailwind CSS</span>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 py-6">
        <!-- Tab Navigation -->
        <div class="flex mb-6 bg-white rounded-lg p-1 shadow-sm">
            <button id="tab-budget" class="flex-1 py-2 px-4 rounded-md text-sm font-medium tab-button active">
                Budsjett Kalkulator
            </button>
            <button id="tab-financing" class="flex-1 py-2 px-4 rounded-md text-sm font-medium tab-button">
                Intern Finansiering
            </button>
        </div>

        <!-- Budget Calculator Tab -->
        <div id="budget-content" class="tab-content">
            <div class="space-y-6">
                <div class="bg-blue-50 p-6 rounded-xl shadow-sm">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        B√•t Budsjett Kalkulator
                    </h2>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Antall personer som deler:</label>
                            <div class="flex items-center gap-3">
                                <button id="family-minus" class="p-2 bg-gray-200 rounded hover:bg-gray-300">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                    </svg>
                                </button>
                                <span id="family-size" class="text-xl font-bold w-12 text-center">4</span>
                                <button id="family-plus" class="p-2 bg-gray-200 rounded hover:bg-gray-300">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">√Örlig budsjett totalt (NOK):</label>
                            <input type="range" id="annual-budget" min="10000" max="150000" step="5000" value="50000" class="w-full">
                            <div id="budget-display" class="text-center font-bold text-lg">50 000 kr</div>
                        </div>
                    </div>

                    <div class="mt-6">
                        <label class="block text-sm font-medium mb-2">Type b√•t:</label>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                            <button data-type="motorboat" class="boat-type-btn p-3 rounded text-sm active">Sjekte/Sjark</button>
                            <button data-type="sailboat" class="boat-type-btn p-3 rounded text-sm">Seilb√•t</button>
                            <button data-type="speedboat" class="boat-type-btn p-3 rounded text-sm">Speedb√•t/Bowrider</button>
                        </div>
                    </div>
                </div>

                <div class="bg-green-50 p-6 rounded-xl shadow-sm">
                    <h3 class="text-lg font-semibold mb-3">Resultat:</h3>
                    <div class="grid md:grid-cols-3 gap-4 text-center">
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div id="max-price" class="text-2xl font-bold text-secondary">714 286 kr</div>
                            <div class="text-sm text-gray-600">Maks kj√∏pspris</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div id="annual-per-person" class="text-2xl font-bold text-primary">12 500 kr</div>
                            <div class="text-sm text-gray-600">√Örlig kostnad per person</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm">
                            <div id="monthly-per-person" class="text-2xl font-bold text-accent">1 041 kr</div>
                            <div class="text-sm text-gray-600">M√•ndelig kostnad per person</div>
                        </div>
                    </div>

                    <div class="mt-6 text-center">
                        <a id="finn-search-link" href="#" target="_blank" rel="noopener noreferrer"
                           class="inline-flex items-center gap-2 bg-accent text-white px-6 py-3 rounded-lg hover:bg-accent-dark shadow-sm hover:shadow-md transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                            <span id="finn-link-text">S√∏k p√• Finn.no</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Financing Calculator Tab -->
        <div id="financing-content" class="tab-content hidden">
            <div class="space-y-6">
                <div class="bg-blue-50 p-6 rounded-xl shadow-sm">
                    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        Intern Finansiering med Forskudd
                    </h2>

                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">B√•tpris (NOK):</label>
                                <input type="number" id="boat-price" value="750000" class="input-field" step="0.01" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Antall personer:</label>
                                <div class="flex items-center gap-2">
                                    <button id="financing-people-minus" class="p-2 bg-gray-200 rounded hover:bg-gray-300">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                        </svg>
                                    </button>
                                    <span id="financing-people-count" class="text-lg font-bold w-8 text-center">4</span>
                                    <button id="financing-people-plus" class="p-2 bg-gray-200 rounded hover:bg-gray-300">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Rente (%):</label>
                                <input type="number" id="interest-rate" value="4.5" class="input-field" step="0.01" min="0" max="20">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">L√•neperiode (√•r):</label>
                                <input type="number" id="loan-years" value="5" class="input-field" step="0.1" min="0.1" max="30">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">√Örlige driftskostnader (NOK):</label>
                            <input type="number" id="annual-costs" value="0" class="input-field" step="0.01" min="0">
                            <p class="text-xs text-gray-600 mt-1">F.eks. forsikring, vedlikehold, vinteropplag, etc.</p>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold">Forskudd per person:</h3>
                        <div id="person-contributions" class="grid gap-3">
                            <!-- Person inputs will be generated here -->
                        </div>
                    </div>
                </div>

                <div class="bg-green-50 p-6 rounded-xl shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Finansieringssammendrag:</h3>
                        <button id="share-financing-btn" class="btn btn-primary flex items-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"></path>
                            </svg>
                            Del konfigurasjon
                        </button>
                    </div>
                    <div id="share-success-message" class="hidden mb-4 p-3 bg-green-100 text-green-700 rounded-lg">
                        ‚úì Lenke kopiert til utklippstavlen!
                    </div>
                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                            <div id="total-upfront" class="text-2xl font-bold text-primary">0 kr</div>
                            <div class="text-sm text-gray-600">Totalt forskudd</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                            <div id="monthly-payment" class="text-2xl font-bold text-secondary">0 kr</div>
                            <div class="text-sm text-gray-600">M√•ndelig betaling (internt)</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                            <div id="total-interest" class="text-2xl font-bold text-accent">0 kr</div>
                            <div class="text-sm text-gray-600">Total rente</div>
                        </div>
                    </div>

                    <h4 class="text-md font-semibold mb-3">M√•nedlig fordeling per person:</h4>
                    <div id="person-breakdown" class="space-y-3">
                        <!-- Person breakdown will be generated here -->
                    </div>

                    <div id="explanation" class="mt-6 p-4 bg-yellow-50 rounded border-l-4 border-yellow-400 hidden">
                        <h4 class="font-semibold text-yellow-800 mb-2">üí° Forklaring:</h4>
                        <ul class="text-sm text-yellow-700 space-y-1">
                            <li id="ownership-explanation">‚Ä¢ Alle eier like store andeler av b√•ten (25% hver)</li>
                            <li>‚Ä¢ De som betalte mindre enn sin andel betaler m√•nedlig til de som betalte mer</li>
                            <li>‚Ä¢ De som betalte mer mottar m√•nedlige betalinger med rente</li>
                            <li id="payoff-explanation">‚Ä¢ Etter 5 √•r er alle utlignet</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        $(document).ready(function() {
            // Application state
            let state = {
                familySize: 4,
                annualBudget: 50000,
                boatType: 'motorboat',
                boatPrice: 750000,
                interestRate: 4.5,
                loanYears: 5,
                annualCosts: 0,  // Annual recurring costs
                personContributions: [],
                financingPeople: 4  // Separate count for financing calculator
            };

            // URL State Management
            function encodeStateToURL() {
                const financingData = {
                    bp: state.boatPrice,  // boat price
                    ir: state.interestRate,  // interest rate
                    ly: state.loanYears,  // loan years
                    ac: state.annualCosts,  // annual costs
                    fp: state.financingPeople,  // financing people count
                    pc: state.personContributions.map(p => ({
                        n: p.name,  // name
                        a: p.amount  // amount
                    }))
                };

                // Only include financing data if we're on the financing tab
                if ($('#tab-financing').hasClass('active')) {
                    const encoded = btoa(JSON.stringify(financingData));
                    const url = new URL(window.location);
                    url.searchParams.set('fin', encoded);
                    url.searchParams.set('tab', 'financing');
                    return url.toString();
                }
                return window.location.href;
            }

            function decodeURLToState() {
                const params = new URLSearchParams(window.location.search);
                const finData = params.get('fin');
                const tab = params.get('tab');

                if (finData) {
                    try {
                        const decoded = JSON.parse(atob(finData));

                        // Update state with decoded data
                        state.boatPrice = decoded.bp || 750000;
                        state.interestRate = decoded.ir || 4.5;
                        state.loanYears = decoded.ly || 5;
                        state.annualCosts = decoded.ac || 0;
                        state.financingPeople = decoded.fp || 4;

                        // Reconstruct person contributions
                        if (decoded.pc && decoded.pc.length > 0) {
                            state.personContributions = decoded.pc.map((p, index) => ({
                                id: index + 1,
                                name: p.n || `Person ${index + 1}`,
                                amount: p.a || 0
                            }));
                            state.financingPeople = decoded.pc.length;
                        }

                        // Update UI with decoded values
                        $('#boat-price').val(state.boatPrice);
                        $('#interest-rate').val(state.interestRate);
                        $('#loan-years').val(state.loanYears);
                        $('#annual-costs').val(state.annualCosts);
                        $('#financing-people-count').text(state.financingPeople);

                        // Switch to financing tab if specified
                        if (tab === 'financing') {
                            $('#tab-financing').click();
                        }

                        return true;
                    } catch (e) {
                        console.error('Failed to decode URL state:', e);
                    }
                }
                return false;
            }

            function updateURL() {
                const newURL = encodeStateToURL();
                window.history.replaceState({}, '', newURL);
            }

            // Cost percentages by boat type
            const costPercentages = {
                motorboat: { avg: 0.07 },  // Sjekte/Sjark
                sailboat: { avg: 0.06 },   // Seilb√•t
                speedboat: { avg: 0.08 }   // Speedb√•t/Bowrider
            };

            // Initialize person contributions for financing calculator
            function initFinancingContributions() {
                const existingContributions = state.personContributions.slice();
                state.personContributions = [];

                for (let i = 1; i <= state.financingPeople; i++) {
                    // Preserve existing data if available
                    const existing = existingContributions[i-1];
                    state.personContributions.push({
                        id: i,
                        name: existing ? existing.name : `Person ${i}`,
                        amount: existing ? existing.amount : 0
                    });
                }

                renderPersonInputs();
                calculateFinancing();
            }

            // Tab functionality
            $('.tab-button').click(function() {
                const tabId = $(this).attr('id');
                const contentId = tabId.replace('tab-', '') + '-content';

                $('.tab-button').removeClass('active bg-primary text-white').addClass('text-gray-700 hover:bg-gray-100');
                $(this).removeClass('text-gray-700 hover:bg-gray-100').addClass('active bg-primary text-white');

                $('.tab-content').addClass('hidden');
                $('#' + contentId).removeClass('hidden');

                if (tabId === 'tab-financing') {
                    // Update display and recalculate when switching to financing tab
                    $('#financing-people-count').text(state.financingPeople);
                    calculateFinancing();
                } else {
                    // Clear URL parameters when switching to budget tab
                    const url = new URL(window.location);
                    url.searchParams.delete('fin');
                    url.searchParams.delete('tab');
                    window.history.replaceState({}, '', url.pathname);
                }
            });

            // Share button functionality
            $('#share-financing-btn').click(function() {
                const shareURL = encodeStateToURL();

                // Copy to clipboard
                navigator.clipboard.writeText(shareURL).then(function() {
                    // Show success message
                    $('#share-success-message').removeClass('hidden');

                    // Hide message after 3 seconds
                    setTimeout(function() {
                        $('#share-success-message').addClass('hidden');
                    }, 3000);
                }).catch(function(err) {
                    // Fallback for older browsers
                    const textArea = document.createElement("textarea");
                    textArea.value = shareURL;
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        $('#share-success-message').removeClass('hidden');
                        setTimeout(function() {
                            $('#share-success-message').addClass('hidden');
                        }, 3000);
                    } catch (err) {
                        alert('Kunne ikke kopiere lenken. URL: ' + shareURL);
                    }
                    document.body.removeChild(textArea);
                });
            });

            // Budget calculator functionality
            $('#family-minus').click(function() {
                if (state.familySize > 1) {
                    state.familySize--;
                    updateBudgetDisplay();
                }
            });

            $('#family-plus').click(function() {
                state.familySize++;
                updateBudgetDisplay();
            });

            $('#annual-budget').on('input', function() {
                state.annualBudget = parseInt($(this).val());
                updateBudgetDisplay();
            });

            $('.boat-type-btn').click(function() {
                $('.boat-type-btn').removeClass('active bg-primary text-white').addClass('bg-white border border-gray-300 hover:bg-gray-50');
                $(this).removeClass('bg-white border border-gray-300 hover:bg-gray-50').addClass('active bg-primary text-white');
                state.boatType = $(this).data('type');
                updateBudgetDisplay();
            });

            function updateBudgetDisplay() {
                $('#family-size').text(state.familySize);
                $('#budget-display').text(state.annualBudget.toLocaleString('no-NO') + ' kr');

                const maxPrice = Math.floor(state.annualBudget / costPercentages[state.boatType].avg);
                const annualPerPerson = state.annualBudget / state.familySize;
                const monthlyPerPerson = Math.floor(annualPerPerson / 12);

                $('#max-price').text(maxPrice.toLocaleString('no-NO') + ' kr');
                $('#annual-per-person').text(annualPerPerson.toLocaleString('no-NO') + ' kr');
                $('#monthly-per-person').text(monthlyPerPerson.toLocaleString('no-NO') + ' kr');

                // Generate Finn.no URL with boat type categories
                let finnUrl = '';
                if (state.boatType === 'motorboat') {
                    // Sjekte/Sjark categories
                    finnUrl = `https://www.finn.no/mobility/search/boat?class=6921&class=6922&class=7962&no_of_seats_from=8&price_from=0&price_to=${maxPrice}&sales_form=120&sales_form=121`;
                } else if (state.boatType === 'sailboat') {
                    // Seilb√•t category
                    finnUrl = `https://www.finn.no/mobility/search/boat?class=2188&no_of_seats_from=8&price_from=0&price_to=${maxPrice}&sales_form=120&sales_form=121`;
                } else if (state.boatType === 'speedboat') {
                    // Speedb√•t/Bowrider categories
                    finnUrl = `https://www.finn.no/mobility/search/boat?class=7961&class=7960&class=3827&no_of_seats_from=8&price_from=0&price_to=${maxPrice}&sales_form=120&sales_form=121`;
                }

                $('#finn-search-link').attr('href', finnUrl);

                // Update link text with boat type
                const boatTypeName = state.boatType === 'motorboat' ? 'Sjekte/Sjark' :
                                   state.boatType === 'sailboat' ? 'Seilb√•t' :
                                   'Speedb√•t/Bowrider';
                $('#finn-link-text').text(`S√∏k ${boatTypeName} p√• Finn.no (opp til ${maxPrice.toLocaleString('no-NO')} kr)`);
            }

            // Financing people counter controls
            $('#financing-people-minus').click(function() {
                if (state.financingPeople > 1) {
                    state.financingPeople--;
                    $('#financing-people-count').text(state.financingPeople);
                    initFinancingContributions();
                }
            });

            $('#financing-people-plus').click(function() {
                state.financingPeople++;
                $('#financing-people-count').text(state.financingPeople);
                initFinancingContributions();
            });

            // Financing calculator functionality
            function renderPersonInputs() {
                const container = $('#person-contributions');
                container.empty();

                state.personContributions.forEach(function(person) {
                    const html = `
                        <div class="flex gap-3 items-center bg-white p-3 rounded">
                            <div class="flex-1">
                                <input type="text" class="person-name input-field text-sm"
                                       data-id="${person.id}" value="${person.name}" placeholder="Navn">
                            </div>
                            <div class="flex-1">
                                <input type="number" class="person-amount input-field"
                                       data-id="${person.id}" value="${person.amount}"
                                       placeholder="Forskudd (NOK)" step="0.01" min="0">
                            </div>
                        </div>
                    `;
                    container.append(html);
                });

                // Bind events for person inputs
                $('.person-name').on('input', function() {
                    const id = parseInt($(this).data('id'));
                    const person = state.personContributions.find(p => p.id === id);
                    if (person) {
                        person.name = $(this).val();
                        calculateFinancing();
                    }
                });

                $('.person-amount').on('input', function() {
                    const id = parseInt($(this).data('id'));
                    const person = state.personContributions.find(p => p.id === id);
                    if (person) {
                        // Use precise decimal handling to avoid floating point errors
                        const value = $(this).val();
                        person.amount = value === '' ? 0 : parseFloat(value);
                        calculateFinancing();
                    }
                });
            }

            $('#boat-price, #interest-rate, #loan-years, #annual-costs').on('input', function() {
                const field = $(this).attr('id').replace('-', '');
                const value = $(this).val();

                if (field === 'boatprice') {
                    state.boatPrice = value === '' ? 0 : parseFloat(value);
                } else if (field === 'interestrate') {
                    state.interestRate = value === '' ? 0 : parseFloat(value);
                } else if (field === 'loanyears') {
                    state.loanYears = value === '' ? 1 : parseFloat(value);
                } else if (field === 'annualcosts') {
                    state.annualCosts = value === '' ? 0 : parseFloat(value);
                }
                calculateFinancing();
            });

            // Enhanced financing calculation based on documentation
            function calculateBoatFinancing(boatPrice, contributions, interestRate, years, annualCosts) {
                const result = {
                    boatPrice: boatPrice,
                    numberOfPeople: contributions.length,
                    equalShare: boatPrice / contributions.length,
                    annualCosts: annualCosts || 0,
                    annualCostPerPerson: (annualCosts || 0) / contributions.length,
                    monthlyCostPerPerson: (annualCosts || 0) / contributions.length / 12,
                    breakdown: [],
                    totalUpfront: 0
                };

                // Step 1: Calculate positions and totals
                let totalLent = 0;
                let totalBorrowed = 0;

                contributions.forEach(function(person) {
                    const amount = person.amount || 0;
                    const excess = amount - result.equalShare;
                    const position = excess > 0 ? "lender" : excess < 0 ? "borrower" : "neutral";

                    if (excess > 0) totalLent += excess;
                    if (excess < 0) totalBorrowed += Math.abs(excess);

                    result.breakdown.push({
                        id: person.id,
                        name: person.name,
                        amount: amount,
                        equalShare: result.equalShare,
                        excess: excess,
                        position: position,
                        isLender: position === "lender",
                        isBorrower: position === "borrower",
                        isNeutral: position === "neutral"
                    });

                    result.totalUpfront += amount;
                });

                // Step 2: Calculate loan parameters
                result.internalLoanAmount = Math.min(totalLent, totalBorrowed);
                result.totalLent = totalLent;
                result.totalBorrowed = totalBorrowed;

                const monthlyRate = interestRate / 100 / 12;
                const numPayments = years * 12;

                result.monthlyPaymentTotal = 0;
                if (result.internalLoanAmount > 0) {
                    if (monthlyRate > 0) {
                        // Standard loan amortization formula
                        result.monthlyPaymentTotal = result.internalLoanAmount *
                            (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) /
                            (Math.pow(1 + monthlyRate, numPayments) - 1);
                    } else {
                        // No interest case
                        result.monthlyPaymentTotal = result.internalLoanAmount / numPayments;
                    }
                }

                // Step 3: Calculate individual payments including recurring costs
                result.breakdown.forEach(function(person) {
                    person.monthlyPayment = 0;
                    person.monthlyReceived = 0;
                    person.monthlyCostShare = result.monthlyCostPerPerson;

                    if (person.position === "borrower" && totalBorrowed > 0) {
                        // Calculate this borrower's proportional share of loan payment
                        const borrowerShare = Math.abs(person.excess) / totalBorrowed;
                        person.monthlyPayment = borrowerShare * result.monthlyPaymentTotal;

                        // Borrowers also pay the lenders' share of recurring costs during loan period
                        if (totalLent > 0 && result.monthlyCostPerPerson > 0) {
                            // Each borrower pays a proportional share of all lenders' costs
                            const lendersCostShare = (totalLent / result.boatPrice) * result.annualCosts / 12;
                            person.monthlyCostPayment = borrowerShare * lendersCostShare;
                            person.monthlyPayment += person.monthlyCostPayment;
                        }

                    } else if (person.position === "lender" && totalLent > 0) {
                        // Calculate this lender's proportional share of loan payment received
                        const lenderShare = person.excess / totalLent;
                        person.monthlyReceived = lenderShare * result.monthlyPaymentTotal;

                        // Lenders receive their share of recurring costs from borrowers
                        if (totalBorrowed > 0 && result.monthlyCostPerPerson > 0) {
                            // This lender's costs are covered by borrowers
                            person.monthlyCostReceived = result.monthlyCostPerPerson;
                            person.monthlyReceived += person.monthlyCostReceived;
                        }
                    }

                    person.netMonthly = person.monthlyReceived - person.monthlyPayment;
                });

                result.totalInterest = (result.monthlyPaymentTotal * numPayments) - result.internalLoanAmount;
                result.loanMonths = numPayments;
                result.loanYears = years;

                return result;
            }

            function calculateFinancing() {
                // Validate that total contributions equal boat price
                const totalContributions = state.personContributions.reduce((sum, p) => sum + (p.amount || 0), 0);

                // Calculate financing using the enhanced algorithm
                const financing = calculateBoatFinancing(
                    state.boatPrice,
                    state.personContributions,
                    state.interestRate,
                    state.loanYears,
                    state.annualCosts
                );

                // Update URL with current state if on financing tab
                if ($('#tab-financing').hasClass('active')) {
                    updateURL();
                }

                // Update summary display with precise formatting
                $('#total-upfront').text(financing.totalUpfront.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' kr');

                // Calculate total monthly payment including recurring costs for lenders
                let totalMonthlyWithCosts = financing.monthlyPaymentTotal || 0;
                if (financing.annualCosts > 0 && financing.totalLent > 0 && financing.totalBorrowed > 0) {
                    // Add the lenders' share of monthly costs that borrowers will pay
                    const lenderCount = financing.breakdown.filter(p => p.position === "lender").length;
                    totalMonthlyWithCosts += lenderCount * financing.monthlyCostPerPerson;
                }

                $('#monthly-payment').text(totalMonthlyWithCosts.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' kr');
                $('#total-interest').text((financing.totalInterest || 0).toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' kr');

                // Add validation warning if contributions don't equal boat price
                const summaryContainer = $('#total-upfront').parent().parent();
                $('.contribution-warning').remove();

                if (Math.abs(totalContributions - state.boatPrice) > 0.01) {
                    const difference = totalContributions - state.boatPrice;
                    const warningHtml = `
                        <div class="contribution-warning mt-4 p-3 rounded ${difference > 0 ? 'bg-yellow-50 border-l-4 border-yellow-400' : 'bg-red-50 border-l-4 border-red-400'}">
                            <div class="text-sm ${difference > 0 ? 'text-yellow-700' : 'text-red-700'}">
                                <strong>‚ö†Ô∏è Varsel:</strong> Totale forskudd (${totalContributions.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr)
                                ${difference > 0 ? 'overstiger' : 'underskyter'} b√•tprisen med ${Math.abs(difference).toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr
                            </div>
                        </div>
                    `;
                    summaryContainer.append(warningHtml);
                }

                // Update person breakdown with enhanced display
                const breakdownContainer = $('#person-breakdown');
                breakdownContainer.empty();

                financing.breakdown.forEach(person => {
                    const statusText = person.position === "lender" ? `L√•ner ut ${Math.abs(person.excess).toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr` :
                                     person.position === "borrower" ? `L√•ner ${Math.abs(person.excess).toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr` :
                                     "Betaler eksakt sin andel";

                    // Build monthly text with breakdown if there are recurring costs
                    let monthlyText = "";
                    if (person.position === "lender") {
                        if (financing.annualCosts > 0 && person.monthlyCostReceived > 0) {
                            const loanReceived = person.monthlyReceived - person.monthlyCostReceived;
                            monthlyText = `Mottar ${person.monthlyReceived.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr/mnd (${loanReceived.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr l√•n + ${person.monthlyCostReceived.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr drift) i ${financing.loanYears} √•r`;
                        } else {
                            monthlyText = `Mottar ${person.monthlyReceived.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr/mnd i ${financing.loanYears} √•r`;
                        }
                    } else if (person.position === "borrower") {
                        if (financing.annualCosts > 0 && person.monthlyCostPayment > 0) {
                            const loanPayment = person.monthlyPayment - person.monthlyCostPayment;
                            monthlyText = `Betaler ${person.monthlyPayment.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr/mnd (${loanPayment.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr l√•n + ${person.monthlyCostPayment.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr drift) i ${financing.loanYears} √•r`;
                        } else {
                            monthlyText = `Betaler ${person.monthlyPayment.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr/mnd i ${financing.loanYears} √•r`;
                        }
                    } else {
                        monthlyText = "Ingen m√•nedlige betalinger";
                    }

                    const html = `
                        <div class="bg-white p-4 rounded border">
                            <div class="flex justify-between items-center mb-3">
                                <span class="font-medium text-lg">${person.name}</span>
                                <span class="text-sm text-gray-500">${(100/state.financingPeople).toFixed(1)}% eierandel</span>
                            </div>

                            <div class="grid md:grid-cols-2 gap-4 mb-3">
                                <div class="bg-gray-50 p-3 rounded">
                                    <div class="text-sm text-gray-600">Forskudd betalt:</div>
                                    <div class="text-xl font-bold">${person.amount.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr</div>
                                    <div class="text-xs text-gray-500">Lik andel: ${person.equalShare.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr</div>
                                </div>
                                <div class="bg-gray-50 p-3 rounded">
                                    <div class="text-sm text-gray-600">Status:</div>
                                    <div class="font-semibold ${person.excess > 0 ? 'text-secondary' : person.excess < 0 ? 'text-red-600' : 'text-gray-600'}">
                                        ${statusText}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">${monthlyText}</div>
                                </div>
                            </div>

                            ${person.position !== "neutral" ? `
                                <div class="border-t pt-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600 font-medium">M√•nedlig netto:</span>
                                        <div class="text-right">
                                            <div class="font-bold text-lg ${person.netMonthly > 0 ? 'text-secondary' : 'text-red-600'}">
                                                ${person.netMonthly > 0 ? '+' : ''}${person.netMonthly.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                ${person.netMonthly > 0 ? 'mottar' : 'betaler'} i ${financing.loanYears} √•r
                                            </div>
                                        </div>
                                    </div>

                                    ${financing.totalInterest > 0 ? `
                                        <div class="mt-2 text-sm text-primary">
                                            üí∞ ${person.position === "lender" ? 'Tjener' : 'Betaler'} totalt
                                            ${((person.position === "lender" ? person.monthlyReceived : person.monthlyPayment) * financing.loanMonths - Math.abs(person.excess)).toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr
                                            i renter
                                        </div>
                                    ` : ''}
                                    ${financing.annualCosts > 0 ? `
                                        <div class="mt-2 text-sm text-gray-600">
                                            üìÖ Etter l√•neperioden: ${person.monthlyCostShare.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr/mnd i driftskostnader
                                        </div>
                                    ` : ''}
                                </div>
                            ` : `
                                <div class="border-t pt-3 text-center">
                                    <span class="text-gray-600 font-medium">‚úÖ Ingen m√•nedlige betalinger n√∏dvendig</span>
                                    ${financing.annualCosts > 0 ? `
                                        <div class="mt-2 text-sm text-gray-600">
                                            üìÖ Betaler ${person.monthlyCostShare.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr/mnd i driftskostnader
                                        </div>
                                    ` : ''}
                                </div>
                            `}
                        </div>
                    `;
                    breakdownContainer.append(html);
                });

                // Enhanced explanation
                if (financing.internalLoanAmount > 0) {
                    $('#explanation').removeClass('hidden');

                    const lenders = financing.breakdown.filter(p => p.position === "lender");
                    const borrowers = financing.breakdown.filter(p => p.position === "borrower");

                    let explanationHtml = `
                        <h4 class="font-semibold text-yellow-800 mb-2">üí° Slik fungerer den interne finansieringen:</h4>
                        <ul class="text-sm text-yellow-700 space-y-1">
                            <li>‚Ä¢ Alle eier like store andeler av b√•ten (${(100/state.financingPeople).toFixed(1)}% hver)</li>
                            <li>‚Ä¢ ${lenders.length} ${lenders.length === 1 ? 'person l√•ner' : 'personer l√•ner'} ut totalt ${financing.totalLent.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr</li>
                            <li>‚Ä¢ ${borrowers.length} ${borrowers.length === 1 ? 'person l√•ner' : 'personer l√•ner'} totalt ${financing.totalBorrowed.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr</li>
                            <li>‚Ä¢ M√•nedlige betalinger p√• ${financing.monthlyPaymentTotal.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr i ${financing.loanYears} √•r (${state.interestRate}% rente)</li>
                            <li>‚Ä¢ Total rentekostnad: ${financing.totalInterest.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr over hele perioden</li>
                    `;

                    if (financing.annualCosts > 0) {
                        const totalMonthlyCosts = financing.annualCosts / 12;
                        const lendersCostShare = (lenders.length * financing.monthlyCostPerPerson).toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        explanationHtml += `
                            <li class="mt-2 font-semibold">üìÖ √Örlige driftskostnader (${financing.annualCosts.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr/√•r):</li>
                            <li>‚Ä¢ Under l√•neperioden: L√•ntakere dekker l√•ngivernes andel (${lendersCostShare} kr/mnd)</li>
                            <li>‚Ä¢ Etter l√•neperioden: Alle betaler sin egen andel (${financing.monthlyCostPerPerson.toLocaleString('no-NO', {minimumFractionDigits: 2, maximumFractionDigits: 2})} kr/mnd hver)</li>
                        `;
                    }

                    explanationHtml += `</ul>`;
                    $('#explanation').html(explanationHtml);
                } else {
                    $('#explanation').addClass('hidden');
                }
            }


            // Initialize
            $('.tab-button.active').removeClass('text-gray-700 hover:bg-gray-100').addClass('bg-primary text-white');
            $('.boat-type-btn.active').removeClass('bg-white border border-gray-300 hover:bg-gray-50').addClass('bg-primary text-white');

            // Check for URL parameters and load state if present
            const hasURLState = decodeURLToState();
            if (hasURLState) {
                // If we loaded from URL, initialize with the loaded data
                initFinancingContributions();
            } else {
                // Otherwise, initialize with defaults
                updateBudgetDisplay();
                initFinancingContributions();
            }
        });
    </script>
</body>
</html>